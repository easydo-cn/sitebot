{% extends "manager_base.html" %}
{% block styles %}
{{ super() }}
    <style type="text/css">
        #syncfolder-description {
            padding: .4em .6em;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="tab-content">
        <p id="syncfolder-description">
            {{_(
                'Connections will be created during folder uploading and downloading,'
                'Operate files in desktop, sync to the site easily.'
            )}}
        </p>
        {% if not sync_folders %}
            <div colspan="3" class="text-center alert alert-info" style="margin-bottom: 5px;">
                {{_('No sync folder')}}
            </div>
        {% else %}
            <table class="table table-striped table-hover" style="margin-bottom: 5px;">
                <thead>
                <tr>
                    <th>{{_('Site name')}}</th>
                    <th>{{_('Sync folder')}}</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                {% for sync_folder in sync_folders %}
                    <tr>
                        <td>
                            {{_(sync_folder.instance_name or sync_folder.instance)}}
                        </td>
                        <td>
                            <a href="/sync/ui_edit" data-id="{{ sync_folder.id }}" class="syncfolder_edit">
                                {{sync_folder.path}}
                            </a>
                        </td>
                        <td>
                            {% if sync_folder.policy == 'auto' %}
                                {% if sync_folder.sync_type == 'up' %}
                                    <i class="fa fa-long-arrow-up fa-1"></i>
                                {% elif sync_folder.sync_type == 'down' %}
                                    <i class="fa fa-long-arrow-down fa-1"></i>
                                {% else %}
                                    <i class="fa fa-arrows-v fa-1"></i>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        {% endif %}

        <div id="general-settings">
        {# 不是所有平台都支持 同步助手 插件 #}
        {% if 'syncplugin' in settings.supported_settings %}
          <section>
            {% if not settings.syncplugin_installed %}
              <a id="activate_syncplugin">{{_('Activate SyncPlugin')}}</a> &nbsp;
              {{_('Show sync menu item and status icon for files.')}}&nbsp;
              <span class="inline_warning">({{_('requires privileged access')}})</span>
            {% endif %}
          </section>
        {% endif %}
        </div>

    </div>
{% endblock %}

{% block scripts %}
    <script type="text/javascript">
        $.ajaxSetup({
            beforeSend: function(xhr, settings){
                xhr.etarget = settings.etarget;
                var _target = xhr.etarget;
                _target.data('href', _target.attr('href'));
                _target.data('text', _target.text());

                _target.attr({'href': 'javascript:void(0);'});
                _target.text('{{_('Please wait')}}...');
            },
            complete: function(xhr, textStatus){
                var _target = xhr.etarget;
                if(_target.data('href') && _target.data('text')){
                    _target.attr({'href': _target.data('href')});
                    _target.text(_target.data('text'))

                    _target.data('href', '');
                    _target.data('text', '');
                }
            }
        });

        function call_open_request(class_name) {
            $(document.body).on('click', class_name, function(e){
                var id = $.trim($(this).data('id'));
                $.ajax({
                    etarget: $(this),
                    url: $(this).attr('href'),
                    cache: false,
                    dataType: 'JSON',
                    data: {
                        id: id
                    },
                    type: 'POST'
                });
                return false;
            });
        }

        document.onselectstart = function(){return false;};
        // 修改同步区属性
        call_open_request('a.syncfolder_edit');

        // 打开本地文件夹
        $('#edo_temp').click(function () {
            $.ajax({
                etarget:$(this),
                cache: false,
                url: $(this).attr('href'),
                type: 'POST',
                data: {
                    local_path: $(this).data('path')
                },
                dataType: 'json',
                success: function (d) {
                }
            });
            return false;
        });
        $(document.body).on('click', '#activate_syncplugin', function(){
            try{
                $(this).attr({'disabled': true});
                native.activateSyncPlugin();
            }catch(e){
                console.error(e);
                $(this).attr({'disabled': false});
            }
        });
    </script>
{% endblock %}
